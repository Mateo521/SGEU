<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout}">

<body>
    <main layout:fragment="content">
        <div class="flex flex-col justify-between gap-4 items-center">
        
            <video class="rounded-xl border-gray-600 border-4" id="video" width="400" height="300" autoplay></video>
            <canvas id="canvas" hidden></canvas>
            <p id="retorno">Escaneando... Apunta la cámara hacia un código QR</p>

            <script src="https://cdn.jsdelivr.net/npm/jsqr@1.1.0/dist/jsQR.min.js"></script>

            <script>
                const video = document.getElementById("video");
                const canvasElement = document.getElementById("canvas");
                const canvas = canvasElement.getContext("2d");
                const retorno = document.getElementById("retorno");

                let lastProcessedCode = null;
                let lastScanTime = 0;
                const scanCooldown = 2000;
                let clearTimeoutId = null;
                let currentVehicleData = null; 

                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                    .then(function (stream) {
                        video.srcObject = stream;
                        video.setAttribute("playsinline", true);
                        video.play();
                        requestAnimationFrame(tick);
                    })
                    .catch(function (err) {
                        console.error("Error accessing camera: ", err);
                    });

                function tick() {
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        canvasElement.height = video.videoHeight;
                        canvasElement.width = video.videoWidth;
                        canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                        const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: "dontInvert",
                        });

                        const now = Date.now();

                        if (code && code.data !== lastProcessedCode && (now - lastScanTime > scanCooldown)) {
                            lastProcessedCode = code.data;
                            lastScanTime = now;

                            retorno.innerHTML = ` Procesando QR: ${code.data}`;
                            console.log("QR detectado:", code.data);

                            if (clearTimeoutId) {
                                clearTimeout(clearTimeoutId);
                            }

                            fetch("/qr/procesar", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ codigo: code.data })
                            })
                                .then(async res => {
                                    const data = await res.json();

                                    if (res.status === 404) {
                                        retorno.innerHTML = `
                                            <div class="bg-red-500 bg-opacity-20 border border-red-400 rounded-lg p-4 text-center">
                                                <div class="text-red-300 font-bold mb-2"> ${data.mensaje}</div>
                                            </div>`;
                                    } else if (!res.ok) {
                                        retorno.innerHTML = `
                                            <div class="bg-orange-500 bg-opacity-20 border border-orange-400 rounded-lg p-4 text-center">
                                                <div class="text-orange-300 font-bold mb-2"> Error: ${data.mensaje}</div>
                                            </div>`;
                                   } else {
    
    currentVehicleData = data;
    
    const statusColor = data.estaAdentro 
        ? 'text-red-400' 
        : 'text-green-400';

    // --- INICIO DE LA LÓGICA DE BOTONES MODIFICADA ---
    let botonesHTML = '';

    if (data.accionDisponible === 'estacionamiento lleno') {
        // Caso 1: Estacionamiento lleno, genera un solo botón naranja infuncional
        botonesHTML = `
        <button class="bg-orange-500 cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 w-full" disabled>
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            Estacionamiento Lleno
        </button>
        `;
    } else {
        // Caso 2: Hay espacio, genera un botón funcional para Entrada o Salida
        const buttonColor = data.accionDisponible === 'Entrada' 
            ? 'bg-green-600 hover:bg-green-700' 
            : 'bg-red-600 hover:bg-red-700';
        
        const buttonContent = data.accionDisponible === 'Entrada'
            ? `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path></svg> Registrar ENTRADA`
            : `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg> Registrar SALIDA`;

        botonesHTML = `
        <button onclick="procesarAccion('${data.patente}', '${data.accionDisponible}')" 
                class="${buttonColor} text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2 w-full">
            ${buttonContent}
        </button>
        `;
    }
    // --- FIN DE LA LÓGICA DE BOTONES ---

    retorno.innerHTML = `
        <div class="bg-green-500 bg-opacity-20 border border-green-400 rounded-lg p-4 text-center mb-4 w-full">
            <div class="text-green-300 font-bold"> Vehículo encontrado</div>
        </div>
        
        <div class="grid grid-cols-1 gap-3 text-sm mb-4 w-full">
            <div class="bg-gray-800 rounded p-3">
                <strong class="text-gray-300 block">Patente:</strong> 
                <span class="text-white font-semibold">${data.patente}</span>
            </div>
            <div class="bg-gray-800 rounded p-3">
                <strong class="text-gray-300 block">Estado:</strong> 
                <span class="${statusColor} font-semibold">${data.mensajeAccion}</span>
            </div>
            <div class="bg-gray-800 rounded p-3">
                <strong class="text-gray-300 block">Modelo:</strong> 
                <span class="text-white">${data.modelo}</span>
            </div>
            <div class="bg-gray-800 rounded p-3">
                <strong class="text-gray-300 block">Color:</strong> 
                <span class="text-white">${data.color}</span>
            </div>
            ${data.nombreDuenio ? `
            <div class="bg-gray-800 rounded p-3">
                <strong class="text-gray-300 block">Dueño:</strong> 
                <span class="text-white">${data.nombreDuenio}</span>
            </div>` : ''}
        </div>
        
        ${botonesHTML}
    `;
}

                                 
                                    clearTimeoutId = setTimeout(() => {
                                        retorno.innerHTML = "Escaneando... Apunta la cámara hacia un código QR";
                                        lastProcessedCode = null;
                                        currentVehicleData = null;
                                    }, 15000);
                                })
                                .catch(err => {
                                    console.error("Error en fetch:", err);
                                    retorno.innerHTML = `
                                        <div class="bg-red-500 bg-opacity-20 border border-red-400 rounded-lg p-4 text-center">
                                            <div class="text-red-300 font-bold mb-2"> Error de conexión con el servidor</div>
                                        </div>`;

                                    clearTimeoutId = setTimeout(() => {
                                        retorno.innerHTML = "Escaneando... Apunta la cámara hacia un código QR";
                                        lastProcessedCode = null;
                                    }, 10000);
                                });
                        }
                    }
                    requestAnimationFrame(tick);
                }

                
                function procesarAccion(patente, accion) {
                    const button = event.target;
                    button.disabled = true;
                    button.innerHTML = '⏳ Procesando...';

                    fetch("/qr/procesar-accion", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ 
                            patente: patente, 
                            accion: accion 
                        })
                    })
                    .then(async res => {
                        const data = await res.json();
                        
                        if (data.resultado) {
                            retorno.innerHTML = `
                                <div class="bg-green-500 bg-opacity-20 border border-green-400 rounded-lg p-4 text-center">
                                    <div class="text-green-300 font-bold text-lg">${data.mensaje}</div>
                                    <div class="text-green-200 mt-2">Patente: ${data.patente}</div>
                                </div>`;
                        } else {
                            retorno.innerHTML = `
                                <div class="bg-red-500 bg-opacity-20 border border-red-400 rounded-lg p-4 text-center">
                                    <div class="text-red-300 font-bold text-lg">${data.mensaje}</div>
                                    <div class="text-red-200 mt-2">Patente: ${data.patente}</div>
                                </div>`;
                        }

                    
                        setTimeout(() => {
                            retorno.innerHTML = "Escaneando... Apunta la cámara hacia un código QR";
                            lastProcessedCode = null;
                            currentVehicleData = null;
                        }, 5000);
                    })
                    .catch(err => {
                        console.error("Error:", err);
                        retorno.innerHTML = `
                            <div class="bg-red-500 bg-opacity-20 border border-red-400 rounded-lg p-4 text-center">
                                <div class="text-red-300 font-bold">Error al procesar la acción</div>
                            </div>`;
                        
                        setTimeout(() => {
                            retorno.innerHTML = "Escaneando... Apunta la cámara hacia un código QR";
                            lastProcessedCode = null;
                        }, 5000);
                    });
                }
            </script>
        </div>
    </main>
</body>
</html>
