  <!-- Fragmento Thymeleaf -->
<div th:fragment="contenido">

  <!-- Barra superior: b√∫squeda + filtros + bot√≥n -->
  <div class="mb-6 rounded-2xl border border-slate-200 bg-gradient-to-r from-slate-50 to-slate-100/70 p-4">
    <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-center justify-between">
      <div class="flex-1 flex gap-3">
        <div class="relative flex-1">
          <input id="ae-searchGuard" type="text" placeholder="Buscar por guardia..."
                 class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          <span class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">üîé</span>
        </div>

        <select id="ae-filterParking"
                class="rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <option value="all">Todos los estacionamientos</option>
          <option value="Norte">Norte</option>
          <option value="Sur">Sur</option>
          <option value="Este">Este</option>
          <option value="Oeste">Oeste</option>
        </select>

        <select id="ae-filterShift"
                class="rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <option value="all">Todos los turnos</option>
          <option value="08:00 - 14:00">Ma√±ana (08:00 - 14:00)</option>
          <option value="14:00 - 21:00">Tarde (14:00 - 21:00)</option>
        </select>
      </div>

      <button id="ae-openModal"
              class="inline-flex items-center justify-center gap-2 rounded-2xl bg-indigo-600 px-5 py-3 text-sm font-medium text-white shadow-md hover:bg-indigo-700 transition">
        <span class="text-lg leading-none">Ôºã</span> Nueva asignaci√≥n
      </button>
    </div>
  </div>

  <!-- Tabla -->
  <div class="bg-white rounded-xl shadow-lg overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full" id="ae-table">
        <thead class="bg-gradient-to-r from-slate-50 to-slate-100 border-b border-slate-200">
          <tr>
            <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Guardia</th>
            <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Estacionamiento</th>
            <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Turno</th>
            <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Fecha</th>
            <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Estado</th>
            <th class="px-6 py-4 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100" id="ae-tbody"><!-- filas JS --></tbody>
      </table>
    </div>

    <div class="flex items-center justify-between px-6 py-4 bg-slate-50 border-t border-slate-200">
      <div class="text-slate-600 text-sm">
        Total de guardias: <span class="font-semibold text-slate-900" id="ae-total">0</span>
      </div>
      <div class="text-slate-500 text-xs">
        √öltima actualizaci√≥n: <span id="ae-lastUpdate"></span>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="ae-modal" class="fixed inset-0 hidden z-50 items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-md rounded-2xl bg-white shadow-2xl">
      <div class="flex items-center justify-between px-6 py-4 border-b">
        <h3 class="text-lg font-semibold text-slate-900" id="ae-modalTitle">Nueva asignaci√≥n</h3>
        <button id="ae-closeModal" class="text-slate-500 hover:text-slate-700 text-xl">&times;</button>
      </div>

      <div class="px-6 py-5 space-y-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Guardia</label>
          <select id="ae-modalGuard" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="">Seleccionar guardia...</option>
          </select>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Estacionamiento</label>
          <select id="ae-modalParking" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="">Seleccionar estacionamiento...</option>
          </select>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Turno</label>
          <select id="ae-modalShift" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="">Seleccionar turno...</option>
            <option value="08:00 - 14:00">Ma√±ana (08:00 - 14:00)</option>
            <option value="14:00 - 21:00">Tarde (14:00 - 21:00)</option>
          </select>
        </div>

        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">Fecha</label>
          <input id="ae-modalDate" type="text" readonly
                 class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-500">
        </div>

        <div class="pt-2 flex justify-end gap-2">
          <button id="ae-cancel" type="button" class="px-4 py-2 rounded-xl border border-slate-200 text-sm text-slate-700 hover:bg-slate-50">Cancelar</button>
          <button id="ae-save"   type="button" class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-medium hover:bg-indigo-700">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS (sin dependencias, id√©ntica l√≥gica a tu demo, con colores adaptados) -->
    <script>
  (function () {
    // === Endpoints
    const API_TURNOS = '/api/turnos';
    const API_EMPLEADOS = '/api/empleados';
    const API_EST = '/api/estacionamientos';

    // === Helpers
    const $ = (id) => document.getElementById(id);
    let turnos = [], empleados = [], estacionamientos = [];
    let editingId = null;
    let page = 0, size = 50;

    async function fetchJSON(url, opts) {
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.headers.get('content-type')?.includes('application/json') ? res.json() : null;
    }
    function today() { return new Date().toISOString().slice(0,10); }
    function nowTime(){ return new Date().toLocaleTimeString('es-AR'); }
    function statusFor(hIn, hOut){
      const [a]=hIn.split(':'), [b]=hOut.split(':'), h=new Date().getHours();
      if (h>=+a && h<+b) return {t:'Activo', cls:'bg-green-100 text-green-700 border-green-200'};
      if (h<+a)         return {t:'Pr√≥ximo', cls:'bg-blue-100 text-blue-700 border-blue-200'};
      return {t:'Finalizado', cls:'bg-slate-100 text-slate-700 border-slate-200'};
    }
    function shiftFrom(hIn,hOut){ return `${hIn} - ${hOut}`; }
    function splitShift(s){ const m=s.match(/(\d{2}:\d{2}).+(\d{2}:\d{2})/); return m?{in:m[1],out:m[2]}:{in:'08:00',out:'14:00'}; }

    // === Render
    function render(list = turnos){
      const tbody = $('ae-tbody');
      if (!list.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-slate-400">
          <div class="text-4xl mb-2">üì≠</div><div class="text-lg">No hay asignaciones</div></td></tr>`;
      } else {
        tbody.innerHTML = list.map(t=>{
          const st = statusFor(t.horaIngreso, t.horaSalida);
          const initials = (t.empleadoNombre||'').split(' ').map(n=>n[0]||'').join('').slice(0,3).toUpperCase();
          return `
            <tr class="hover:bg-slate-50 transition-colors">
              <td class="px-6 py-4"><div class="flex items-center">
                <div class="mr-3 grid place-items-center w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-blue-500 text-white text-sm font-bold">${initials||'G'}</div>
                <div class="text-slate-900 font-medium">${t.empleadoNombre||'-'}</div></div></td>
              <td class="px-6 py-4"><span class="inline-flex items-center px-3 py-1 rounded-lg bg-violet-50 border border-violet-200 text-violet-700 text-sm">üÖøÔ∏è ${t.estacionamientoNombre||'-'}</span></td>
              <td class="px-6 py-4"><span class="text-slate-700 font-medium">${shiftFrom(t.horaIngreso,t.horaSalida)}</span></td>
              <td class="px-6 py-4"><span class="text-slate-600">${t.fechaInicio}</span></td>
              <td class="px-6 py-4"><span class="px-3 py-1 rounded-full text-xs font-semibold border ${st.cls}">${st.t}</span></td>
              <td class="px-6 py-4">
                <div class="flex justify-end gap-2">
                  <button data-edit="${t.id}" class="p-2 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50">‚úèÔ∏è</button>
                  <button data-del="${t.id}"  class="p-2 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50">üóëÔ∏è</button>
                </div>
              </td>
            </tr>`;
        }).join('');
      }
      $('ae-total').textContent = list.length.toString();
      $('ae-lastUpdate').textContent = nowTime();

      tbody.querySelectorAll('[data-edit]').forEach(b=> b.onclick = ()=> openEdit(+b.dataset.edit));
      tbody.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=> delTurno(+b.dataset.del));
    }

    // === Combos
    async function loadCombos(){
      try { empleados = await fetchJSON(API_EMPLEADOS) || []; } catch { empleados=[]; }
      try { estacionamientos = await fetchJSON(API_EST) || []; } catch { estacionamientos=[]; }

      $('ae-modalGuard').innerHTML  = `<option value="">Seleccionar guardia...</option>` +
        empleados.map(e=>`<option value="${e.id}">${e.nombre}</option>`).join('');
      $('ae-modalParking').innerHTML= `<option value="">Seleccionar estacionamiento...</option>` +
        estacionamientos.map(e=>`<option value="${e.id}">${e.nombre}</option>`).join('');
    }

    // === API turnos
    async function loadTurnos(){
      const resp = await fetchJSON(`${API_TURNOS}?page=${page}&size=${size}`);
      turnos = resp?.content || [];
      render(turnos);
    }

    // === CRUD
    function openNew(){
      editingId = null;
      $('ae-modalTitle').textContent = 'Nueva asignaci√≥n';
      $('ae-modalGuard').value=''; $('ae-modalParking').value='';
      $('ae-modalShift').value='08:00 - 14:00'; $('ae-modalDate').value=today();
      $('ae-modal').classList.remove('hidden'); $('ae-modal').classList.add('flex');
    }
    function openEdit(id){
      const t = turnos.find(x=>x.id===id); if(!t) return;
      editingId = id;
      $('ae-modalTitle').textContent = 'Editar asignaci√≥n';
      $('ae-modalGuard').value = t.empleadoId;
      $('ae-modalParking').value = t.estacionamientoId;
      $('ae-modalShift').value = `${t.horaIngreso} - ${t.horaSalida}`;
      $('ae-modalDate').value = t.fechaInicio;
      $('ae-modal').classList.remove('hidden'); $('ae-modal').classList.add('flex');
    }
    function closeModal(){ $('ae-modal').classList.add('hidden'); $('ae-modal').classList.remove('flex'); }

    async function saveTurno(){
      const empleadoId = parseInt($('ae-modalGuard').value,10);
      const estacionamientoId = parseInt($('ae-modalParking').value,10);
      const {in:horaIngreso, out:horaSalida} = splitShift($('ae-modalShift').value);
      const fechaInicio = $('ae-modalDate').value || today();

      if(!empleadoId || !estacionamientoId){ alert('Complet√° guardia y estacionamiento.'); return; }

      const payload = { empleadoId, estacionamientoId, fechaInicio, fechaFin:null, horaIngreso, horaSalida };
      if (editingId) {
        await fetchJSON(`${API_TURNOS}/${editingId}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      } else {
        await fetchJSON(API_TURNOS, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      }
      await loadTurnos(); closeModal();
    }
    async function delTurno(id){
      if(!confirm('¬øEliminar esta asignaci√≥n?')) return;
      await fetchJSON(`${API_TURNOS}/${id}`, { method:'DELETE' });
      await loadTurnos();
    }

    // === Filtros (front)
    function applyFilters(){
      const q = $('ae-searchGuard').value.trim().toLowerCase();
      const p = $('ae-filterParking').value;
      const sh= $('ae-filterShift').value;
      const filtered = turnos.filter(t=>{
        const byName = !q || (t.empleadoNombre||'').toLowerCase().includes(q);
        const byParking = p==='all' || t.estacionamientoNombre===p;
        const byShift = sh==='all' || `${t.horaIngreso} - ${t.horaSalida}` === sh;
        return byName && byParking && byShift;
      });
      render(filtered);
    }

    // === Wire UI
    function wire(){
      $('ae-openModal').onclick = openNew;
      $('ae-closeModal').onclick = closeModal;
      $('ae-cancel').onclick    = closeModal;
      $('ae-save').onclick      = saveTurno;

      $('ae-searchGuard').oninput   = applyFilters;
      $('ae-filterParking').onchange= applyFilters;
      $('ae-filterShift').onchange  = applyFilters;

      document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });
      setInterval(()=>{ $('ae-lastUpdate').textContent = nowTime(); }, 1000);
    }

    // === Init
    (async function init(){
      wire();
      await loadCombos();
      await loadTurnos();
    })();
  })();
  </script>
</div>

