<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Estadísticas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        neo: {
                            bg: '#e0e5ec',
                            light: '#ffffff',
                            dark: '#a3b1c6',
                            text: '#2c3e50',
                            secondary: '#5a6c7d',
                            accent: '#667eea'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: #e0e5ec;
        }
        
        .neo-card {
            background: #e0e5ec;
            box-shadow: 12px 12px 24px #a3b1c6, -12px -12px 24px #ffffff;
            transition: all 0.3s ease;
        }
        
        .neo-card:hover {
            box-shadow: 16px 16px 32px #a3b1c6, -16px -16px 32px #ffffff;
        }
        
        .neo-inset {
            background: #e0e5ec;
            box-shadow: inset 6px 6px 12px #a3b1c6, inset -6px -6px 12px #ffffff;
        }
        
        .neo-row {
            background: #e0e5ec;
            box-shadow: 6px 6px 12px #a3b1c6, -6px -6px 12px #ffffff;
            transition: all 0.3s ease;
        }
        
        .neo-row:hover {
            transform: translateY(-2px);
            box-shadow: 8px 8px 16px #a3b1c6, -8px -8px 16px #ffffff;
        }
        
        .neo-title {
            text-shadow: 2px 2px 4px #a3b1c6, -2px -2px 4px #ffffff;
        }

        .neo-button {
            background: #e0e5ec;
            box-shadow: 8px 8px 16px #a3b1c6, -8px -8px 16px #ffffff;
            transition: all 0.2s ease;
        }

        .neo-button:hover {
            box-shadow: 6px 6px 12px #a3b1c6, -6px -6px 12px #ffffff;
        }

        .neo-button:active {
            box-shadow: inset 4px 4px 8px #a3b1c6, inset -4px -4px 8px #ffffff;
        }

        .neo-input {
            background: #e0e5ec;
            box-shadow: inset 4px 4px 8px #a3b1c6, inset -4px -4px 8px #ffffff;
            border: none;
            outline: none;
        }

        .neo-input:focus {
            box-shadow: inset 6px 6px 12px #a3b1c6, inset -6px -6px 12px #ffffff;
        }

        .chart-container {
            background: #e0e5ec;
            box-shadow: inset 4px 4px 8px #a3b1c6, inset -4px -4px 8px #ffffff;
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body class="min-h-screen py-8 px-4">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-5xl font-light text-center mb-8 tracking-[0.15em] text-neo-text neo-title">
            ESTADÍSTICAS
        </h1>

        <!-- Filtros -->
        <div class="neo-card rounded-3xl p-6 mb-8">
            <form id="filtro" class="flex flex-wrap gap-4 items-end">
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-semibold text-neo-secondary mb-2 tracking-wide uppercase">Desde</label>
                    <input type="date" id="desde" name="desde" 
                           class="neo-input w-full px-4 py-3 rounded-xl text-neo-text font-medium"/>
                </div>
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-semibold text-neo-secondary mb-2 tracking-wide uppercase">Hasta</label>
                    <input type="date" id="hasta" name="hasta" 
                           class="neo-input w-full px-4 py-3 rounded-xl text-neo-text font-medium"/>
                </div>
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-semibold text-neo-secondary mb-2 tracking-wide uppercase">Estacionamiento</label>
                    <select id="estId" class="neo-input w-full px-4 py-3 rounded-xl text-neo-text font-medium">
                        <option value="">Todos los estacionamientos</option>
                    </select>
                </div>
                <button type="submit" class="neo-button px-8 py-3 rounded-xl text-neo-accent font-semibold tracking-wide uppercase hover:text-neo-text">
                    Aplicar
                </button>
            </form>
        </div>

        <div id="info" class="text-center text-neo-accent font-medium mb-4"></div>

        <!-- Grid de gráficos principales -->
        <div class="grid md:grid-cols-2 gap-8 mb-8">
            <!-- Categorías -->
            <div class="neo-card rounded-3xl p-6">
                <h3 class="text-xl font-medium mb-4 text-neo-accent tracking-wide">
                    Porcentaje por categoría
                </h3>
                <div class="chart-container">
                    <canvas id="chartCategorias"></canvas>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full" id="tablaCategorias">
                        <thead>
                            <tr>
                                <th class="text-left py-3 px-4 text-neo-secondary text-xs font-semibold tracking-wider uppercase">Categoria</th>
                                <th class="text-left py-3 px-4 text-neo-secondary text-xs font-semibold tracking-wider uppercase">Cantidad</th>
                                <th class="text-left py-3 px-4 text-neo-secondary text-xs font-semibold tracking-wider uppercase">%</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Ocupación -->
            <div class="neo-card rounded-3xl p-6">
                <h3 class="text-xl font-medium mb-4 text-neo-accent tracking-wide">
                    Ocupación por estacionamiento
                </h3>
                <div class="chart-container">
                    <canvas id="chartOcupacion"></canvas>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full" id="tablaOcupacion">
                        <thead>
                            <tr>
                                <th class="text-left py-3 px-4 text-neo-secondary text-xs font-semibold tracking-wider uppercase">Estacionamiento</th>
                                <th class="text-left py-3 px-4 text-neo-secondary text-xs font-semibold tracking-wider uppercase">Capacidad</th>
                                <th class="text-left py-3 px-4 text-neo-secondary text-xs font-semibold tracking-wider uppercase">Ingresos</th>
                                <th class="text-left py-3 px-4 text-neo-secondary text-xs font-semibold tracking-wider uppercase">%</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Evolución diaria -->
        <div class="neo-card rounded-3xl p-6 mb-8">
            <h3 class="text-xl font-medium mb-4 text-neo-accent tracking-wide">
                Evolución diaria
            </h3>
            <div class="chart-container">
                <canvas id="chartEvolucion"></canvas>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full" id="tablaEvolucion">
                    <thead>
                        <tr>
                            <th class="text-left py-3 px-4 text-neo-secondary text-xs font-semibold tracking-wider uppercase">Fecha</th>
                            <th class="text-left py-3 px-4 text-neo-secondary text-xs font-semibold tracking-wider uppercase">Cantidad</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Horarios pico -->
        <div class="neo-card rounded-3xl p-6 mb-8">
            <h3 class="text-xl font-medium mb-4 text-neo-accent tracking-wide">
                Horarios pico
            </h3>
            <div class="chart-container">
                <canvas id="chartHorarios"></canvas>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full" id="tablaHorarios">
                    <thead>
                        <tr>
                            <th class="text-left py-3 px-4 text-neo-secondary text-xs font-semibold tracking-wider uppercase">Hora</th>
                            <th class="text-left py-3 px-4 text-neo-secondary text-xs font-semibold tracking-wider uppercase">Cantidad</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Conteo por modo -->
        <div class="neo-card rounded-3xl p-6 mb-8">
            <h3 class="text-xl font-medium mb-4 text-neo-accent tracking-wide">
                Conteo por modo (MANUAL / QR)
            </h3>
            <div class="overflow-x-auto">
                <table class="w-full" id="tablaModo">
                    <thead>
                        <tr>
                            <th class="text-left py-3 px-4 text-neo-secondary text-xs font-semibold tracking-wider uppercase">Modo</th>
                            <th class="text-left py-3 px-4 text-neo-secondary text-xs font-semibold tracking-wider uppercase">Cantidad</th>
                            <th class="text-left py-3 px-4 text-neo-secondary text-xs font-semibold tracking-wider uppercase">%</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    let chartInstances = {};

    async function fetchEstacionamientos(){
        try{
            const resp = await fetch('/api/estacionamientos');
            if(!resp.ok) return [];
            const json = await resp.json();
            return json || [];
        }catch(e){ return []; }
    }

    function getQueryParams(){
        const params = new URLSearchParams(window.location.search);
        return {
            desde: params.get('desde') || '',
            hasta: params.get('hasta') || '',
            estId: params.get('estId') || ''
        };
    }

    function setFormFromParams(){
        const p = getQueryParams();
        document.getElementById('desde').value = p.desde;
        document.getElementById('hasta').value = p.hasta;
        document.getElementById('estId').value = p.estId;
    }

    async function load(){
        const info = document.getElementById('info');
        info.textContent = 'Cargando estacionamientos...';
        const ests = await fetchEstacionamientos();
        const sel = document.getElementById('estId');
        sel.querySelectorAll('option:not([value=""])').forEach(o=>o.remove());
        for(const e of ests){
            const opt = document.createElement('option');
            opt.value = e.id;
            opt.textContent = e.nombre;
            sel.appendChild(opt);
        }
        setFormFromParams();
        await cargarDatos();
    }

    async function cargarDatos(){
        const info = document.getElementById('info');
        info.textContent = 'Cargando datos...';
        const p = getQueryParams();
        const q = new URLSearchParams();
        if(p.desde) q.set('desde', p.desde);
        if(p.hasta) q.set('hasta', p.hasta);
        if(p.estId) q.set('estId', p.estId);
        try{
            const resp = await fetch('/estadisticas?' + q.toString(), { headers: { 'Accept':'application/json' } });
            if(!resp.ok){ info.textContent = 'Error cargando datos: ' + resp.status; return; }
            const json = await resp.json();
            const data = json.data || json;
            renderAll(data);
            info.textContent = '';
        }catch(e){ info.textContent = 'No se pudo conectar al servidor'; }
    }

    function renderAll(data){
        // Limpiar gráficos anteriores
        Object.values(chartInstances).forEach(chart => chart.destroy());
        chartInstances = {};

        // categorias
        const tbodyC = document.querySelector('#tablaCategorias tbody'); 
        tbodyC.innerHTML='';
        (data.categorias||[]).forEach(c => {
            const tr = document.createElement('tr');
            tr.className = 'neo-row rounded-xl';
            tr.innerHTML = `<td class="py-3 px-4 text-neo-text rounded-l-xl">${c.categoria}</td><td class="py-3 px-4 text-neo-text">${c.cantidad}</td><td class="py-3 px-4 text-neo-accent font-semibold rounded-r-xl">${c.porcentaje}%</td>`;
            tbodyC.appendChild(tr);
        });

        // ocupacion
        const tbodyO = document.querySelector('#tablaOcupacion tbody'); 
        tbodyO.innerHTML='';
        (data.porcentajeOcupacion||[]).forEach(e => {
            const tr = document.createElement('tr');
            tr.className = 'neo-row rounded-xl';
            tr.innerHTML = `<td class="py-3 px-4 text-neo-text rounded-l-xl">${e.nombre}</td><td class="py-3 px-4 text-neo-text">${e.capacidad}</td><td class="py-3 px-4 text-neo-text">${e.ingresos}</td><td class="py-3 px-4 text-neo-accent font-semibold rounded-r-xl">${e.porcentaje}%</td>`;
            tbodyO.appendChild(tr);
        });

        // evolucion
        const tbodyE = document.querySelector('#tablaEvolucion tbody'); 
        tbodyE.innerHTML='';
        (data.evolucion||[]).forEach(d => {
            const tr = document.createElement('tr');
            tr.className = 'neo-row rounded-xl';
            tr.innerHTML = `<td class="py-3 px-4 text-neo-text rounded-l-xl">${d.dia}</td><td class="py-3 px-4 text-neo-accent font-semibold rounded-r-xl">${d.cantidad}</td>`;
            tbodyE.appendChild(tr);
        });

        // horarios
        const tbodyH = document.querySelector('#tablaHorarios tbody'); 
        tbodyH.innerHTML='';
        (data.horariosPico||[]).forEach(h => {
            const tr = document.createElement('tr');
            tr.className = 'neo-row rounded-xl';
            tr.innerHTML = `<td class="py-3 px-4 text-neo-text rounded-l-xl">${h.hora}</td><td class="py-3 px-4 text-neo-accent font-semibold rounded-r-xl">${h.cantidad}</td>`;
            tbodyH.appendChild(tr);
        });

        // modos
        const tbodyM = document.querySelector('#tablaModo tbody'); 
        tbodyM.innerHTML='';
        (data.conteoModos||data.modoConteo||[]).forEach(m => {
            const tr = document.createElement('tr');
            tr.className = 'neo-row rounded-xl';
            tr.innerHTML = `<td class="py-3 px-4 text-neo-text rounded-l-xl">${m.modo}</td><td class="py-3 px-4 text-neo-text">${m.cantidad}</td><td class="py-3 px-4 text-neo-accent font-semibold rounded-r-xl">${m.porcentaje}%</td>`;
            tbodyM.appendChild(tr);
        });

        // Configuración global de Chart.js
        const chartDefaults = {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    labels: {
                        color: '#2c3e50',
                        font: { size: 12, weight: '500' },
                        padding: 15
                    }
                }
            }
        };

        // Chart Categorías (Doughnut mejorado)
        const categoriasLabels = data.categoriasLabels || (data.categorias||[]).map(c=>c.categoria);
        const categoriasData = data.categoriasData || (data.categorias||[]).map(c=>c.cantidad);
        const ctxC = document.getElementById('chartCategorias').getContext('2d');
        chartInstances.categorias = new Chart(ctxC, { 
            type:'doughnut', 
            data:{ 
                labels:categoriasLabels, 
                datasets:[{ 
                    data:categoriasData, 
                    backgroundColor:['#667eea','#764ba2','#f093fb','#4facfe'],
                    borderWidth: 0,
                    hoverOffset: 15
                }] 
            },
            options: {
                ...chartDefaults,
                cutout: '65%',
                plugins: {
                    ...chartDefaults.plugins,
                    legend: { position: 'bottom' }
                }
            }
        });

        // Chart Ocupación
        const ocupLabels = data.ocupacionLabels || (data.porcentajeOcupacion||[]).map(e=>e.nombre);
        const ocupData = data.ocupacionData || (data.porcentajeOcupacion||[]).map(e=>e.porcentaje);
        const ctxO = document.getElementById('chartOcupacion').getContext('2d');
        chartInstances.ocupacion = new Chart(ctxO, { 
            type:'bar', 
            data:{ 
                labels:ocupLabels, 
                datasets:[{ 
                    label:'% Ocupación', 
                    data:ocupData, 
                    backgroundColor:'rgba(102, 126, 234, 0.8)',
                    borderRadius: 8,
                    borderSkipped: false
                }] 
            }, 
            options:{ 
                ...chartDefaults,
                scales:{ 
                    y:{ 
                        beginAtZero:true,
                        grid: { color: 'rgba(163, 177, 198, 0.2)' },
                        ticks: { color: '#5a6c7d', font: { size: 11 } }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#5a6c7d', font: { size: 11 } }
                    }
                } 
            } 
        });

        // Chart Evolución
        const evoLabels = data.evolucionLabels || (data.evolucion||[]).map(d=>d.dia);
        const evoData = data.evolucionData || (data.evolucion||[]).map(d=>d.cantidad);
        const ctxE = document.getElementById('chartEvolucion').getContext('2d');
        chartInstances.evolucion = new Chart(ctxE, { 
            type:'line', 
            data:{ 
                labels:evoLabels, 
                datasets:[{ 
                    label:'Ingresos diarios', 
                    data:evoData, 
                    borderColor:'#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 7
                }] 
            }, 
            options:{ 
                ...chartDefaults,
                scales:{ 
                    y:{ 
                        beginAtZero:true,
                        grid: { color: 'rgba(163, 177, 198, 0.2)' },
                        ticks: { color: '#5a6c7d', font: { size: 11 } }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#5a6c7d', font: { size: 11 } }
                    }
                } 
            } 
        });

        // Chart Horarios
        const horarios = data.horariosPico || [];
        const ctxH = document.getElementById('chartHorarios').getContext('2d');
        chartInstances.horarios = new Chart(ctxH, { 
            type:'bar', 
            data:{ 
                labels:horarios.map(h=>h.hora), 
                datasets:[{ 
                    label:'Ingresos por hora', 
                    data:horarios.map(h=>h.cantidad), 
                    backgroundColor:'rgba(118, 75, 162, 0.8)',
                    borderRadius: 8,
                    borderSkipped: false
                }] 
            }, 
            options:{ 
                ...chartDefaults,
                scales:{ 
                    y:{ 
                        beginAtZero:true,
                        grid: { color: 'rgba(163, 177, 198, 0.2)' },
                        ticks: { color: '#5a6c7d', font: { size: 11 } }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#5a6c7d', font: { size: 11 } }
                    }
                } 
            } 
        });
    }

    // formulario
    document.getElementById('filtro').addEventListener('submit', function(e){
        e.preventDefault();
        const desde = document.getElementById('desde').value;
        const hasta = document.getElementById('hasta').value;
        const estId = document.getElementById('estId').value;
        const params = new URLSearchParams();
        if(desde) params.set('desde', desde);
        if(hasta) params.set('hasta', hasta);
        if(estId) params.set('estId', estId);
        window.location.search = params.toString();
    });

    load();
    </script>
</body>
</html>